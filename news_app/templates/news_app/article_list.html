{% extends "base.html" %}

{% block title %}Articles/Newsletters{% endblock %}

{% block content %}
<h1>Latest Articles and Newsletters</h1>
<p>
    <h3>Information messages:</h3>
    {% if user.is_authenticated %}
    Logged in user: {{ user.username }}<br>
    Role: {{ user.role }}<br>
    {% else %}
    You are not logged in
    {% endif %}
</p>
{% if messages %}
<ul class="messages">
    {% for message in messages %}
    <li{% if message.tags %} class="{{ message.tags }}" {% endif %}>{{ message }}</li>
        {% endfor %}
</ul>
{% endif %}

<h1>Articles</h1>
<ul>
    {% for article in article_list %}
    {% if article.editor_approved or user.role == 'Editor' and user.publisher == article.article_author.publisher or article.article_author == user or article.independent_journalist %}
    <li>
        <a href="{% url 'view_article' article.pk %}">
            <div>
                <h5>{{ article.title }}</h5>
            </div>
        </a>
        <small>by {{ article.article_author.username }} {% if article.independent_journalist %} (Published by Independent Journalist) {% endif %}
            {% if not article.independent_journalist %}
                {% if not article.editor_approved %}
                    (Pending Editor Approval)
                {% else %}
                    (Published by {{ article.article_author.publisher }})
                {% endif %}
            {% endif %}
        </small><br>
        ___________________________________
    </li>
    {% endif %}
    {% empty %}
    <li>No articles have been posted yet.</li>
    {% endfor %}
</ul>

<h1>Newsletters</h1>
<ul>
    {% for newsletter in newsletter_list %}
    {% if newsletter.editor_approved or user.role == 'Editor' and user.publisher == newsletter.newsletter_author.publisher or newsletter.newsletter_author == user or newsletter.independent_journalist %}
    <li>
        <a href="{% url 'view_newsletter' newsletter.pk %}">
            <div>
                <h5>{{ newsletter.title }}</h5>
            </div>
        </a>
        <small>by {{ newsletter.newsletter_author.username }} {% if newsletter.independent_journalist %} (Published by Independent Journalist) {% endif %}
            {% if not newsletter.independent_journalist %}
            {% if not newsletter.editor_approved %}
                (Pending Editor Approval)
            {% else %}
                (Published by {{ newsletter.newsletter_author.publisher }})
            {% endif %}
            {% endif %}
        </small><br>
        ___________________________________
    </li>
    {% endif %}
    {% empty %}
    <li>No newsletters have been posted yet.</li>
    {% endfor %}
</ul>

{% if user.role == 'Reader' %}
<h1>Subscriptions</h1>
<ul>
    <h2>Journalists:</h2>
    {% for journalist in user.subscribed_journalists.all %}
        {{ journalist.username }}
        {% if not forloop.last %}, 
        {% endif %}
        {% empty %}
            None
    {% endfor %}<br>
    <h2>Publishers:</h2>
        {% for publisher in user.subscribed_publishers.all %}
        {{ publisher.name }}
        {% if not forloop.last %},
        {% endif %}
        {% empty %}
            None
    {% endfor %}<br>
{% endif %}
</ul>
<p>
    User options:<br>
    {% if not user.is_authenticated %}
        Don't have an account? <a href="{% url 'register' %}" class="btn btn-secondary">Register here</a><br>
        <a href="{% url 'login' %}" class="btn btn-secondary">Log in</a><br>
        <a href="{% url 'password_reset_request' %}" class="btn btn-secondary">Reset password</a><br>
    {% endif %}
    {% if user.is_authenticated %}
        <a href="{% url 'logout' %}" class="btn btn-secondary">Log out</a><br>
        <a href="{% url 'change_password' %}" class="btn btn-secondary">Change password</a><br>
    {% endif %}
    {% if user.role == 'Reader' %}
        <a href="{% url 'manage_subscriptions' %}" class="btn btn-secondary">Manage subscriptions</a><br>
    {% endif %}
    {% if perms.news_app.add_article %}
        <a href="{% url 'add_article' %}" class="btn btn-secondary">Add article</a><br>
        <a href="{% url 'add_newsletter' %}" class="btn btn-secondary">Add newsletter</a><br>
    {% endif %}
</p>
{% endblock %}